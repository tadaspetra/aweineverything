---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { Sources } from "../../components/Sources.tsx";

export async function getStaticPaths() {
  const essays = await getCollection("essays", ({ data }) => !data.draft);

  return essays.map((essay) => {
    // Handle both folder-based (how-computers-work/index.mdx) and flat (my-essay.mdx) structures
    const parts = essay.id.split("/");
    const slug =
      parts.length > 1
        ? parts[0] // Folder-based: use folder name as slug
        : parts[0].replace(/\.mdx?$/, ""); // Flat file: remove extension
    return {
      params: { slug },
      props: { essay, slug },
    };
  });
}

const { essay, slug } = Astro.props;
const { Content } = await essay.render();

const ogImage = `/${slug}/index.png`;
---

<Layout
  title={essay.data.title}
  description={essay.data.description}
  ogImage={ogImage}
>
  <main class="max-w-2xl mx-auto px-4 sm:px-6 py-12 sm:py-16 md:py-24">
    <article class="prose dark:prose-invert prose-neutral max-w-none">
      <h1 class="mb-0 pb-0">{essay.data.title}</h1>
      <p class="text-neutral-500 dark:text-neutral-400 pb-4">
        an essay by <a href="https://tadaspetra.com" target="_blank"
          >Tadas Petra</a
        >
      </p>
      <Sources sources={essay.data.sources ?? []} client:load />
      <Content />
    </article>
  </main>
</Layout>
